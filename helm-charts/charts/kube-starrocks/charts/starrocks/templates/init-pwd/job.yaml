{{- if and .Values.initPassword.enabled .Release.IsInstall }}
apiVersion: batch/v1
kind: Job
metadata:
  name: starrocks-initpwd
  namespace: {{ template "starrockscluster.namespace" . }}
  {{- if .Values.initPassword.annotations }}
  annotations:
    {{- toYaml .Values.initPassword.annotations | nindent 4 }}
  {{- end }}
spec:
  template:
    spec:
      {{- if or .Values.starrocksFESpec.imagePullSecrets .Values.starrocksCluster.componentValues.imagePullSecrets }}
      imagePullSecrets:
        {{- include "starrockscluster.fe.imagePullSecrets" . | nindent 6 }}
      {{- end }}
      {{- if or .Values.starrocksFESpec.affinity .Values.starrocksCluster.componentValues.affinity }}
      affinity:
        {{- include "starrockscluster.fe.affinity" . | nindent 8 }}
      {{- end }}
      {{- if or .Values.starrocksFESpec.tolerations .Values.starrocksCluster.componentValues.tolerations }}
      tolerations:
        {{- include "starrockscluster.fe.tolerations" . | nindent 8 }}
      {{- end }}
      containers:
      - name: {{ template "starrockscluster.name" . }}-initpwd
        {{- if .Values.initPassword.image }}
        image: {{ .Values.initPassword.image }}
        {{- else }}
        image: {{ .Values.starrocksFESpec.image.repository }}:{{ include "starrockscluster.fe.image.tag" . }}
        {{- end }}
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        args:
        - /opt/starrocks/fe_initpwd.sh
        - {{ template "starrockscluster.name" . }}-fe-0.{{ template "starrockscluster.name" . }}-fe-search
        - "{{- default 9030 (include "starrockscluster.fe.query.port" .) }}"
        env:
        - name: INIT_PWD
          valueFrom:
            secretKeyRef:
              key: password
              name: {{ template "starrockscluster.initpassword.secret.name" . }}
        volumeMounts:
        - mountPath: /opt/starrocks/fe_initpwd.sh
          name: fe-initpwd-shell
          subPath: fe_initpwd.sh
      volumes:
      - configMap:
          defaultMode: 420
          items:
            - key: fe_initpwd.sh
              path: fe_initpwd.sh
          name: init-pwd-shell
          optional: false
        name: fe-initpwd-shell
      restartPolicy: OnFailure
  backoffLimit: 10
{{- end }}
