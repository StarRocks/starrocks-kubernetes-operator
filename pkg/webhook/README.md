# StarRocks Kubernetes Operator Webhooks

This directory contains the admission webhook implementation for the StarRocks Kubernetes Operator.

## Overview

The operator includes a validating admission webhook that validates StarRocksCluster resources before they are created or updated in the Kubernetes cluster.

## Webhook Functionality

The validating webhook performs the following validations:

1. **Cluster Configuration Validation**
   - Validates that FE (Frontend) configuration is present and valid
   - Ensures proper resource requirements are specified
   - Validates storage configuration

2. **High Availability Validation**
   - Ensures proper HA configuration when multiple FE replicas are specified
   - Validates that HA requirements are met

3. **Autoscaling Validation**
   - Validates autoscaling policies for CN (Compute Node) groups
   - Ensures autoscaling parameters are within valid ranges

## Deployment Methods

The operator can be deployed using two methods:

### Method 1: Helm Chart (Recommended)

The webhook can be enabled/disabled through Helm values:

```yaml
# values.yaml
starrocksOperator:
  webhook:
    enabled: true  # Set to false to disable webhooks
```

**Using Custom Certificates:**
```yaml
starrocksOperator:
  webhook:
    enabled: true
    tls:
      secretName: "my-webhook-certs"  # Secret containing tls.crt and tls.key
```

**Deploy with Helm:**
```bash
helm install starrocks-operator ./helm-charts/charts/kube-starrocks/charts/operator \
  --set starrocksOperator.webhook.enabled=true
```

### Method 2: Direct YAML Application

Apply the generated YAML files directly:

```bash
# Apply CRDs first
kubectl apply -f deploy/starrocks.com_starrocksclusters.yaml
kubectl apply -f deploy/starrocks.com_starrockswarehouses.yaml

# Apply operator (generated by scripts/operator.sh)
kubectl apply -f deploy/operator.yaml
```

## Certificate Management

### Automatic Self-Signed Certificates (Default)

When webhooks are enabled, the operator automatically generates self-signed certificates **only if they don't already exist**. This is suitable for development and testing environments.

**Certificate Generation Conditions:**
- Webhooks are enabled (`--enable-webhooks` flag or `starrocksOperator.webhook.enabled=true`)
- No custom certificate secret is provided (`starrocksOperator.webhook.tls.secretName` is empty)
- Certificate files (`tls.crt` or `tls.key`) don't exist in the certificate directory

**Generated Certificate Properties:**
- Location: `/tmp/k8s-webhook-server/serving-certs/`
- Files: `tls.crt` (certificate) and `tls.key` (private key)
- Validity: Configurable via `starrocksOperator.webhook.tls.validityDays` (default: 365 days)
- Subject Alternative Names (SAN): Includes service DNS names and localhost
- Encryption: RSA 2048-bit key

### Custom Certificates (Production)

For production deployments, provide your own certificates:

1. **Create a Kubernetes Secret:**
   ```bash
   kubectl create secret tls webhook-server-certs \
       --cert=path/to/tls.crt \
       --key=path/to/tls.key \
       -n starrocks
   ```

2. **Configure Helm Values:**
   ```yaml
   starrocksOperator:
     webhook:
       enabled: true
       tls:
         secretName: "webhook-server-certs"
   ```

### Using cert-manager (Recommended for Production)

Install cert-manager and configure it to manage webhook certificates automatically:

```yaml
# cert-manager issuer and certificate resources
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: webhook-server-certs
  namespace: starrocks
spec:
  secretName: webhook-server-certs
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
  dnsNames:
  - webhook-service.starrocks.svc
  - webhook-service.starrocks.svc.cluster.local
```

## Local Development

### Prerequisites

- Kubernetes cluster (local or remote)
- kubectl configured to access the cluster
- StarRocks CRDs installed

### Running Locally with Webhooks

```bash
# Build and run with webhooks enabled (default 365 days validity)
make run -- --enable-webhooks

# Run with custom certificate validity (e.g., 30 days for testing)
make run -- --enable-webhooks --webhook-cert-validity-days=30
```

The operator will automatically:
1. Generate self-signed certificates if none exist (with specified validity period)
2. Start the webhook server on port 9443
3. Register validation endpoints

**Certificate Regeneration:**
To force certificate regeneration, delete the existing certificate files:
```bash
rm -rf /tmp/k8s-webhook-server/serving-certs/
make run -- --enable-webhooks
```

## Testing the Webhook

1. **Create a Valid StarRocksCluster:**
   ```bash
   kubectl apply -f examples/starrocks-fe-and-be.yaml
   ```

2. **Test Validation with Invalid Configuration:**
   Try creating a StarRocksCluster with invalid configuration to see webhook validation in action.

## Configuration Options

### Helm Values Reference

```yaml
starrocksOperator:
  webhook:
    # Whether to enable the admission webhook
    enabled: false
    
    # Service configuration for webhook
    service:
      name: webhook-service
      port: 443
      targetPort: 9443
    
    # ValidatingAdmissionWebhook configuration
    validatingWebhook:
      name: starrockscluster-validating-webhook
      path: /validate-starrocks-com-v1-starrockscluster
      failurePolicy: Fail
    
    # TLS certificate configuration for webhook server
    tls:
      # Secret name containing TLS certificate and key
      secretName: ""  # Empty means auto-generate self-signed certs
      # Certificate directory path in the container
      certDir: "/tmp/k8s-webhook-server/serving-certs"
      # Certificate file name
      certName: "tls.crt"
      # Private key file name
      keyName: "tls.key"
      # Certificate validity period in days for self-signed certificates
      # Only used when secretName is empty (auto-generated certificates)
      # Valid range: 1-3650 days (1 day to 10 years)
      validityDays: 365
```

## Troubleshooting

### Common Issues

1. **Certificate Issues:**
   - Check operator logs for certificate generation errors
   - Verify certificate validity and SAN entries
   - Ensure webhook service name matches certificate CN

2. **Network Issues:**
   - Verify webhook service is accessible from API server
   - Check firewall rules and network policies
   - Confirm correct port configuration (9443)

3. **RBAC Issues:**
   - Ensure operator has permissions for webhook resources
   - Check ValidatingAdmissionWebhookConfiguration creation permissions

4. **API Version Issues:**
   - The webhook template automatically detects Kubernetes version compatibility
   - For Kubernetes < 1.16: Uses `admissionregistration.k8s.io/v1beta1`
   - For Kubernetes >= 1.16: Uses `admissionregistration.k8s.io/v1`
   - If you get "no matches for kind ValidatingAdmissionWebhook" error, this indicates the template is working correctly with version detection

### Debugging Commands

```bash
# Check webhook configuration
kubectl get validatingadmissionwebhook

# Check webhook service
kubectl get svc webhook-service -n starrocks

# Check operator logs
kubectl logs -l app=kube-starrocks-operator -n starrocks

# Test webhook connectivity
kubectl port-forward svc/webhook-service 9443:443 -n starrocks
```

## Webhook API

The webhook implements the following endpoints:

- `/validate-starrocks-com-v1-starrockscluster` - Validates StarRocksCluster resources

For detailed validation logic, see `starrockscluster_webhook.go`.

## Validation Rules

### Cluster Configuration
- Ensures FE (Frontend) specification is always present as it's required
- Validates cluster name length (max 63 characters)
- Checks immutable fields during updates

### Frontend (FE) Validation
- Validates replica count is positive
- For HA deployments (replicas > 1):
  - Requires at least 3 replicas
  - Requires odd number of replicas for proper quorum
- Validates that image is specified
- Validates resource requests and limits

### Backend (BE) Validation
- Validates replica count is positive
- Validates that image is specified
- Validates resource requests and limits

### Compute Node (CN) Validation
- Validates replica count is non-negative (0 is allowed)
- Validates that image is specified
- Validates resource requests and limits
- Validates autoscaling policy if present

### Autoscaling Policy Validation
- Ensures maxReplicas > 0
- Ensures minReplicas >= 0
- Ensures minReplicas <= maxReplicas
- Validates HPA metrics are specified when using HPA

### Resource Validation
- Ensures resource limits are greater than or equal to requests
- Validates both CPU and memory constraints