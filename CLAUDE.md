# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Build and Development
- `make build` - Build the operator binary (output: bin/sroperator)
- `make run` - Run the controller locally from your host
- `make docker` - Build Docker image (requires IMG environment variable)
- `make test` - Run all tests with coverage
- `make fmt` - Format Go code (fails if formatting needed)
- `make vet` - Run go vet static analysis
- `make tidy` - Clean up go.mod dependencies

### Code Quality and Testing Workflow
When making code changes, always run these commands in order:
1. `golangci-lint run` - Check code quality and style
2. `make build` - Verify code compiles successfully
3. `go test ./pkg/path/to/your/package` - Run unit tests for modified packages
4. `make test` - Run full test suite if needed

**Important**: All three checks must pass before committing code changes.

### Code Generation
- `make generate` - Generate DeepCopy methods for API types
- `make manifests` - Generate CRDs, webhooks, and RBAC manifests
- `make crd-all` - Generate all CRDs and API documentation
- `make gen-api` - Generate API reference documentation (NOTE: This automatically runs during `make build` - no need to run separately)

### Kubernetes Deployment
- `make install` - Install CRDs into current Kubernetes cluster
- `make deploy` - Deploy operator to current Kubernetes cluster
- `make uninstall` - Remove CRDs from cluster
- `make undeploy` - Remove operator from cluster

## Architecture

### Core Components
This is a Kubernetes operator for StarRocks, an OLAP database system. The operator manages three main component types:
- **FE (Frontend)** - Query coordination and metadata management
- **BE (Backend)** - Data storage and compute for OLAP workloads  
- **CN (Compute Node)** - Elastic compute nodes, can be auto-scaled

### Code Structure
- `pkg/apis/starrocks/v1/` - CRD definitions for StarRocksCluster and StarRocksWarehouse
- `pkg/controllers/` - Main reconciliation controllers for the CRDs
- `pkg/subcontrollers/` - Component-specific controllers (fe/, be/, cn/, feproxy/)
- `pkg/k8sutils/` - Kubernetes resource management utilities and templates
- `pkg/common/` - Shared utilities (hashing, logging, resource utils)
- `cmd/main.go` - Operator entry point
- `config/crd/` - CRD definitions and patches (only CRDs remain after kustomize removal)
- `deploy/` - Generated YAML files for direct application (generated by scripts/operator.sh)
- `helm-charts/` - Helm charts for operator and StarRocks deployment
  - `charts/kube-starrocks/` - Parent chart composed of two sub-charts
  - `charts/kube-starrocks/charts/operator/` - Operator deployment chart
  - `charts/kube-starrocks/charts/starrocks/` - StarRocks cluster deployment chart
- `examples/` - Sample StarRocks cluster configurations

### Key Patterns
- Uses Kubebuilder v3 framework for operator development
- Employs subcontroller pattern where main controllers delegate to component-specific subcontrollers
- Extensive use of Kubernetes templates in `pkg/k8sutils/templates/` for generating resources
- Auto-scaling support specifically for CN (Compute Node) components
- Support for both direct YAML application and Helm-based deployment
- Kustomize support has been removed - only Helm charts and direct YAML files are supported

### Testing
- Unit tests are co-located with source files (`*_test.go`)
- Integration tests use controller-runtime's envtest framework
- Test coverage reports generated during `make test`
- Uses go-sqlmock for database interaction testing

### Important Files
- `pkg/apis/starrocks/v1/starrockscluster_types.go` - Main CRD specification
- `pkg/controllers/starrockscluster_controller.go` - Primary reconciliation logic
- `pkg/subcontrollers/subcontroller.go` - Base interface for component controllers
- `pkg/webhook/starrockscluster_webhook.go` - Validating admission webhook for StarRocksCluster
- `scripts/operator.sh` - Generates `deploy/operator.yaml` using `helm template`
- `scripts/create-parent-chart-values.sh` - Generates parent chart values.yaml

### Webhook Configuration
- The operator includes a validating admission webhook that validates StarRocksCluster resources
- Webhook validates cluster configuration, resource requirements, HA settings, and autoscaling policies
- Webhook can be enabled/disabled through Helm values (`starrocksOperator.webhook.enabled`)
- Supports both automatic self-signed certificate generation and custom certificates

#### Local Development with Webhooks
- By default, webhooks are disabled when running locally (`make run`)
- To enable webhooks locally: `make run -- --enable-webhooks`
- The operator automatically generates self-signed certificates when webhooks are enabled
- No manual certificate generation needed for local development

#### Production Deployment with Webhooks
- Enable webhooks in Helm values: `starrocksOperator.webhook.enabled=true`
- For custom certificates, provide secret name in `starrocksOperator.webhook.tls.secretName`
- Recommended to use cert-manager for automatic certificate management

#### Webhook Certificate Management
- The operator automatically generates self-signed certificates when webhooks are enabled and no custom certificate is provided
- Certificates are stored in an emptyDir volume mounted at the path specified by `starrocksOperator.webhook.tls.certDir`
- The operator dynamically updates the ValidatingAdmissionWebhook configuration with the CA bundle after startup
- This ensures proper TLS verification between Kubernetes API server and the webhook endpoint
- For production use, consider using cert-manager or providing your own certificates via `starrocksOperator.webhook.tls.secretName`